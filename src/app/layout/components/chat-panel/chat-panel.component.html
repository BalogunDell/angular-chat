<div class="header mat-elevation-z4 primary" fxLayout="row" fxLayoutAlign="space-between center">

    <ng-container *ngIf="selectedUser === null">

        <div class="title ml-16" fxLayout="row" fxLayoutAlign="start center"
             (click)="openChatBar()">

            <mat-icon class="s-32 fuse-white-fg">chat</mat-icon>
            <h3 class="ml-12">{{ chatHeader }}</h3>
        </div>

    </ng-container>

    <ng-container *ngIf="selectedUser !== null">

        <div class="title" fxLayout="row" fxLayoutAlign="start center"  (click)="openChatBar()">
            <div *ngIf="selectedUser.groupId || selectedUser.group?.groupId"
                class="group-name-title"
                matTooltipPosition="left">{{selectedUser.group.name.slice(0,2).toUpperCase()}}
            </div>
            <img [src]="selectedUser.avatar" class="avatar mx-16" *ngIf="selectedUser.id">
            <h3 class="text-truncate">{{selectedUser.username || selectedUser.name}}</h3>
        </div>

    </ng-container>

    <div class="users-dropdown" *ngIf="selectedUser?.isAdmin || selectedUser?.group?.isAdmin || isForwadingMessage">
        <mat-form-field>
            <mat-select placeholder="add contact">
                <mat-option *ngFor="let user of contactsWithoutGroups" [value]="user" (click)="addUserToGroup(user)">{{user.username}}</mat-option>
            </mat-select>
        </mat-form-field>
    </div>
    
        <div>
            <button mat-icon-button [matMenuTriggerFor]="chatOptions">
                    <mat-icon>more_vert</mat-icon>
                </button>
                    
                <mat-menu #chatOptions="matMenu">
                    
                    <button mat-menu-item (click)="attachFile()" [disabled]="!selectedUser">
                        <input type="file" (change)="sendFile($event)" id="chatFile" [style.display]="'none'">
                        <mat-icon>attach_file</mat-icon>
                        <span>Send File</span>
                    </button>

                    <button mat-menu-item [disabled]="!selectedUser">
                        <mat-icon>audiotrack</mat-icon>
                        <span>Send Voice Note</span>
                    </button>

                    <button mat-menu-item [disabled]="!selectedUser">
                        <mat-icon>import_export</mat-icon>
                        <span>Export Chat</span>
                    </button>

                    <button mat-menu-item [disabled]="!selectedUser" (click)="enableChatForwarding(true, false)">
                        <mat-icon>forward</mat-icon>
                        <span>Forward chat</span>
                    </button>

                    <button mat-menu-item (click)="addNewGroup()">
                        <mat-icon>group_add</mat-icon>
                        <span>New Group chat</span>
                    </button>

                    <button mat-menu-item (click)="deleteGroup()" [disabled]="!selectedUser || !selectedUser?.isAdmin">
                        <mat-icon>delete</mat-icon>
                        <span>Delete Group</span>
                    </button>

                    <button mat-menu-item>
                        <mat-icon>clear_all</mat-icon>
                        <span>Clear Chat</span>
                    </button>

                    <button mat-menu-item class="toggle-sidebar-folded mr-8" (click)="closeChatBar()">
                        <mat-icon>close</mat-icon>
                        <span>Minimize chat</span>
                    </button>   
                </mat-menu>
    </div>

    <button mat-icon-button class="toggle-sidebar-open mr-8" (click)="toggleSidebarOpen()"
            fxHide.gt-md>
        <mat-icon class="secondary-text">close</mat-icon>
    </button>

</div>

<div class="content">
    <!-- Contacts -->
        <div id="contacts-list" fusePerfectScrollbar [fusePerfectScrollbarOptions]="{suppressScrollX: true}">
  
            <div *ngFor="let user of allContacts; let i = index"
                 class="contacts-list-item"
                 (click)="selectChatPartner(user, i)"
                 [ngClass]="{'active': user.id === selectedUser?.id}"
                 >
                  <img *ngIf="user.id"
                    class="avatar" src={{user.avatar}}
                    [matTooltip]="user.username"
                    matTooltipPosition="left"
                  >

                  <div *ngIf="user.groupId"
                  class="group-name"
                  [matTooltip]="user.group.name"
                  matTooltipPosition="left"
                >{{user.group.name.slice(0,2).toUpperCase()}}</div>
                   <div class="unread-count" *ngIf="user.unread">{{user.unread}}</div>
                <div class="status-icon" [ngClass]="user.status" *ngIf="user.id"></div>
    
            </div>
        </div>
        
          <!-- Chat panel -->
  <div id="chat" fxFlex="1 1 auto">

    <div class="messages-container" id="container" #container (scroll)="loadMoreMessagesOnScroll($event)">
     <ng-container *ngIf="messagesList.length > 0">
        <div *ngFor="let message of messagesList; let i = index"
                [ngClass]="{
                'sender': message.senderId === userCredentials.userId,
                'receiver': message.senderId !== userCredentials.userId,
                'first-of-group': isFirstMessageOfGroup(message, i),
                'last-of-group': isLastMessageOfGroup(message, i)
                }">
            <img 
                *ngIf="message.senderId !== userCredentials.userId"
                src={{selectedUser?.avatar}} 
                class="avatar" 
                alt=""
            >
            <div class="message-wrapper" (mouseenter)="showMessageActionsHandler(true, i)" (mouseleave)="showMessageActionsHandler(false, i)">
                    <div class="message" *ngIf="message.messageType === 'txt'">
                        <div *ngIf="isForwadingMessage" ><input type="checkbox" (change)="getSelectedMessage(message, i)"> {{ message.content }}</div>
                        <p *ngIf="!isForwadingMessage">{{ message.content }}</p>
                        <app-message-actions-dropdown [messageType]="message.messageType"></app-message-actions-dropdown>
                    </div>

                    <div class="message" *ngIf="message.messageType === 'doc'">
                            <div *ngIf="isForwadingMessage"> 
                                 <input type="checkbox" (change)="getSelectedMessage(message, i)">{{ message.content }}
                            </div>
                            <a href={{message.content}} target="_blank">{{message.content}}</a>                    
                            <app-message-actions-dropdown [messageType]="message.messageType"></app-message-actions-dropdown>
                        </div>


                    <div class="message" *ngIf="message.messageType === 'img'" (click)="openFile(message.content, message.messageType)">
                        <input type="checkbox" (change)="getSelectedMessage(message, i)" *ngIf="isForwadingMessage">
                            <app-message-actions-dropdown [messageType]="message.messageType"></app-message-actions-dropdown>
                            <img src="{{message.content}}" alt="new image uploaded"/>
                    </div>
                    
                    <div class="time">{{message.chatTime}}</div>
            </div>
        </div>
    </ng-container>

    <ng-container *ngIf="groupChatMessages.length > 0 && showUserChatGroups">
        <!-- <div *ngFor="let message of messagesList; let i = index"
                [ngClass]="{
                'sender': message.senderId === userCredentials.userId,
                'receiver': message.senderId !== userCredentials.userId,
                'first-of-group': isFirstMessageOfGroup(message, i),
                'last-of-group': isLastMessageOfGroup(message, i)
                }">
            <img 
                *ngIf="message.senderId !== userCredentials.userId"
                src={{selectedUser?.avatar}} 
                class="avatar" 
                alt=""
            >
            <div class="message-wrapper">
                    <div class="message" *ngIf="!message.image">
                            {{message.content}}
                    </div>

                    <div class="message" *ngIf="message.image">
                        <img src="{{message.content}}" alt="new image uploaded"/>
                    </div>
                    
                    <div class="time">{{message.chatTime}}</div>
            </div>
        </div> -->
    </ng-container>


    <ng-container *ngIf="showPlaceHolderIconAndText">

            <div class="no-messages-icon">
                <mat-icon class="s-128 fade-text">chat</mat-icon>
            </div>

            <div class="no-messages secondary-text">
               {{placeholderMessage}}
            </div>

        </ng-container>

        <!-- <ng-container *ngIf="!selectedUser || showCreateGroupForm">

            <div class="no-contact-selected">

                <div class="no-contact-icon">
                    <mat-icon class="s-128 fade-text">chat</mat-icon>
                </div>

                <div class="no-contact secondary-text">
                    {{ newConversationText }}
                </div>

            </div>

        </ng-container> -->

    </div>

    <div class="reply-form-container" *ngIf="showReplyForm">
        <form #replyForm="ngForm"
        (ngSubmit)="sendMessage(replyForm)"
        (keydown.enter)="sendMessage(replyForm)"
        fxFlex fxLayout="row" fxLayoutAlign="start center">

        <mat-form-field class="message-text" fxFlex floatLabel="never" appearance="standard">
            <textarea matInput #replyInput ngModel name="message" placeholder="Type your message"
                    [rows]="1" [matTextareaAutosize]="true"></textarea>
        </mat-form-field>
        <button class="send-message-button" mat-icon-button type="submit" aria-label="Send message">
            <mat-icon class="secondary-text">send</mat-icon>
        </button>

      </form>
    </div>

    <div class="reply-form-container" *ngIf="showCreateGroupForm">
        <form #createGroupForm="ngForm"
        (ngSubmit)="createGroup(createGroupForm)"
        fxFlex fxLayout="row" fxLayoutAlign="start center">

        <mat-form-field class="message-text" fxFlex floatLabel="never" appearance="standard">
            <textarea matInput #groupName ngModel name="groupName" placeholder="Type a group name..."
                    [rows]="1" [matTextareaAutosize]="false" maxlength="20"></textarea>
        </mat-form-field>
        <button class="send-message-button" mat-icon-button type="submit" aria-label="Create group">
            <mat-icon class="secondary-text">group_add</mat-icon>
        </button>

      </form>
    </div>

    <div class="forward-chat-buttons" *ngIf="isForwadingMessage">
        <button class="send-message-button" mat-button aria-label="Cancel" (click)="enableChatForwarding(false, true)">Cancel</button>
        <button class="send-message-button" mat-button aria-label="Forward">Forward</button>
    </div>

</div>

<!-- Chat panel ends -->

    </div>
    <!-- / Contacts -->
